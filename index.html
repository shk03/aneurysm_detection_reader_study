<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aneurysm Detection Reader Study</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        line-height: 1.6;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: #1e293b;
        min-height: 100vh;
      }

      .container {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }

      h1 {
        color: #1e293b;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        font-weight: 600;
      }

      .study-intro {
        text-align: center;
        margin-bottom: 40px;
        padding: 20px;
        background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
        border-radius: 12px;
        border-left: 4px solid #0ea5e9;
      }

      .study-intro h2 {
        color: #0c4a6e;
        margin-bottom: 15px;
      }

      .study-intro p {
        color: #0369a1;
        font-size: 1.1em;
        margin-bottom: 10px;
      }

      /* Collapsible Sections */
      .collapsible-section {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        margin-bottom: 20px;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .collapsible-section:hover {
        border-color: #3b82f6;
      }

      .section-header {
        background: #f8fafc;
        padding: 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
      }

      .section-header:hover {
        background: #f1f5f9;
      }

      .section-header h3 {
        margin: 0;
        color: #1e293b;
        font-size: 1.2em;
      }

      .section-header .toggle-icon {
        font-size: 1.2em;
        color: #6b7280;
        transition: transform 0.3s ease;
      }

      .section-header.active .toggle-icon {
        transform: rotate(180deg);
      }

      .section-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
        padding: 0 20px;
      }

      .section-content.active {
        max-height: 1000px;
        padding: 20px;
      }

      .section-content h4 {
        color: #374151;
        margin-top: 20px;
        margin-bottom: 10px;
      }

      .section-content ul {
        margin: 10px 0;
        padding-left: 20px;
      }

      .section-content li {
        margin-bottom: 8px;
      }

      /* Consent Section */
      .consent-section {
        background: #fef3c7;
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 25px;
        margin: 30px 0;
      }

      .consent-section h3 {
        color: #92400e;
        margin-bottom: 20px;
        text-align: center;
      }

      .checkbox-group {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .checkbox-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
        font-size: 0.95em;
      }

      .checkbox-item:last-child {
        margin-bottom: 0;
      }

      .checkbox-item input[type="checkbox"] {
        margin-right: 12px;
        margin-top: 4px;
        transform: scale(1.2);
        cursor: pointer;
      }

      .checkbox-item label {
        cursor: pointer;
        flex: 1;
      }

      .signature-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
      }

      .signature-input {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .input-group {
        display: flex;
        flex-direction: column;
      }

      .input-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #374151;
      }

      .input-group input {
        padding: 12px;
        border: 2px solid #d1d5db;
        border-radius: 6px;
        font-size: 1em;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .digital-signature {
        margin-top: 15px;
        padding: 20px;
        background: #f8fafc;
        border: 2px dashed #d1d5db;
        border-radius: 6px;
        text-align: left;
        color: #6b7280;
        font-style: italic;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        line-height: 1.8;
      }

      .digital-signature.completed {
        background: #f0fdf4;
        border-color: #10b981;
        color: #047857;
        font-style: normal;
      }

      .digital-signature .signature-name {
        font-size: 1.2em;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 5px;
      }

      .digital-signature .signature-email {
        color: #4b5563;
        margin-bottom: 8px;
      }

      .digital-signature .signature-date {
        font-size: 0.9em;
        color: #6b7280;
        font-style: italic;
        border-top: 1px solid #e5e7eb;
        padding-top: 8px;
        margin-top: 8px;
      }

      /* Study Participation Section */
      .study-section {
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        border: 2px solid #10b981;
        border-radius: 12px;
        padding: 30px;
        margin-top: 30px;
        text-align: center;
        opacity: 0.5;
        transition: all 0.3s ease;
      }

      .study-section.enabled {
        opacity: 1;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
      }

      .study-section h3 {
        color: #065f46;
        margin-bottom: 15px;
      }

      .study-section p {
        color: #047857;
        margin-bottom: 25px;
      }

      /* Buttons */
      .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 50px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin: 5px;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
      }

      .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover:not(:disabled) {
        background: #059669;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
      }

      .btn-success:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .error-message {
        color: #dc2626;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
        padding: 12px;
        margin: 15px 0;
        display: none;
      }

      .success-message {
        color: #059669;
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 6px;
        padding: 15px;
        margin: 15px 0;
        display: none;
        text-align: center;
      }

      /* Responsive Design */
      @media (max-width: 600px) {
        body {
          padding: 10px;
        }

        .container {
          padding: 20px;
        }

        .signature-input {
          grid-template-columns: 1fr;
        }

        h1 {
          font-size: 2em;
        }
      }

      /* Progress indicator */
      .progress-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
        gap: 10px;
      }

      .progress-step {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #6b7280;
        transition: all 0.3s ease;
      }

      .progress-step.active {
        background: #3b82f6;
        color: white;
      }

      .progress-step.completed {
        background: #10b981;
        color: white;
      }

      .progress-line {
        width: 50px;
        height: 2px;
        background: #e5e7eb;
        transition: all 0.3s ease;
      }

      .progress-line.completed {
        background: #10b981;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Study Participation</h1>

      <div class="study-intro">
        <h2>AI-Assisted Intracranial Aneurysm Detection</h2>
        <p><strong>Estimated Time:</strong> 60 minutes</p>
      </div>

      <!-- Collapsible Information Sections -->
      <div class="collapsible-section">
        <div class="section-header" onclick="toggleSection(this)">
          <h3>Participation Requirements</h3>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="section-content">
          <p>
            We invite radiology residents and radiologists in active clinical
            practice to participate. All levels of experience are accepted, and
            no previous exposure to AI or neuroradiology is necessary.
          </p>
        </div>
      </div>

      <div class="collapsible-section">
        <div class="section-header" onclick="toggleSection(this)">
          <h3>Purpose and Procedure</h3>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="section-content">
          <h4>Purpose</h4>
          <p>
            You are being invited to participate in a research study conducted
            at the Technical University of Munich. The aim of this study is to
            evaluate how AI-supported diagnosis affects the accuracy and
            decision-making of radiologists when assessing brain MRIs for
            possible aneurysms.
          </p>

          <h4>Procedure</h4>
          <p>
            If you agree to participate in this study, you will be randomly
            assigned to one of two study conditions. In both groups, you will:
          </p>
          <ul>
            <li>
              Review 20 brain MRI cases in which an AI system has flagged
              potential aneurysms
            </li>
            <li>
              Review the AI findings, provide a diagnosis, and suggest a
              follow-up recommendation for each case
            </li>
            <li>
              Complete a brief questionnaire about your demographic profile and
              experience
            </li>
            <li>This will take approximately 60 minutes to complete</li>
          </ul>
        </div>
      </div>

      <div class="collapsible-section">
        <div class="section-header" onclick="toggleSection(this)">
          <h3>Risks and Benefits</h3>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="section-content">
          <h4>Risks</h4>
          <p>
            There are no known risks associated with participation in this
            study.
          </p>

          <h4>Benefits</h4>
          <p>
            While there may be no direct benefit to you, your contribution will
            support valuable research in the development and evaluation of AI
            tools in neuroradiology.
          </p>
        </div>
      </div>

      <div class="collapsible-section">
        <div class="section-header" onclick="toggleSection(this)">
          <h3>Data Privacy and Rights</h3>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="section-content">
          <h4>Data Protection</h4>
          <p>
            Your privacy and confidentiality will be strictly protected. All
            data will be:
          </p>
          <ul>
            <li>Pseudonymized for analysis</li>
            <li>Stored securely on encrypted, password-protected systems</li>
            <li>Accessed only by authorized research personnel</li>
            <li>Deleted approximately 12 months after study completion</li>
          </ul>

          <h4>Data Use</h4>
          <p>Your pseudonymized data may be used for:</p>
          <ul>
            <li>Statistical analysis for this research study</li>
            <li>Future related research studies</li>
            <li>
              Publication in academic journals (no personal information will be
              included)
            </li>
          </ul>
          <h4>Voluntary Participation</h4>

          <ul>
            <li>
              Your participation in this study is entirely voluntary. You may
              decline to participate, withdraw from the study at any time, or
              request that your data be removed from the study.
            </li>
            <li>
              There is no monetary compensation for participation in this study.
            </li>
          </ul>
        </div>
      </div>

      <div class="collapsible-section">
        <div class="section-header" onclick="toggleSection(this)">
          <h3>Contact</h3>
          <span class="toggle-icon">▼</span>
        </div>
        <div class="section-content">
          <h4>Research Team</h4>
          <p>If you have questions about this study, please contact:</p>
          <p>
            Dr. Su Hwan Kim, MSc<br />
            Institute of Diagnostic and Interventional Radiology<br />
            TUM University Hospital<br />
            Email: suhwan.kim@tum.de
          </p>

          <h4>Research Ethics</h4>
          <p>
            This study has been reviewed and approved by the TUM Ethics
            Committee.
          </p>
        </div>
      </div>

      <!-- Consent Section -->
      <div class="consent-section">
        <h3>Informed Consent and Digital Signature</h3>

        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="readConsent" required />
            <label for="readConsent"
              >I have read and understood all the information provided about
              this research study.</label
            >
          </div>
        </div>

        <div class="signature-section">
          <h4>Digital Signature</h4>
          <div class="signature-input">
            <div class="input-group">
              <label for="participantName">Full Name *</label>
              <input
                type="text"
                id="participantName"
                required
                placeholder="Enter your full legal name"
              />
            </div>

            <div class="input-group">
              <label for="participantEmail">Email Address *</label>
              <input
                type="email"
                id="participantEmail"
                required
                placeholder="Enter your email address"
              />
            </div>
          </div>

          <div class="digital-signature" id="digitalSignature">
            Digital signature will appear here when form is completed
          </div>
        </div>

        <div class="error-message" id="errorMessage">
          Please complete all required fields and check all boxes to proceed.
        </div>

        <div style="text-align: center; margin-top: 20px">
          <button
            class="btn btn-primary"
            id="consentButton"
            onclick="recordConsent()"
            disabled
          >
            ✅ I Give My Consent
          </button>
        </div>
      </div>

      <!-- Study Participation Section -->
      <div class="study-section" id="studySection">
        <h3>Ready to Begin Study</h3>
        <p>
          Thank you for providing your informed consent. <br />You will now be
          randomly assigned to one of two study conditions.
        </p>

        <div class="success-message" id="successMessage">
          ✅ Consent recorded successfully! You can now proceed to the study.
        </div>

        <button
          class="btn btn-success"
          id="participateBtn"
          onclick="randomRedirect()"
          disabled
        >
          START
        </button>
      </div>
    </div>

    <script>
      // ============================================
      // CONFIGURE YOUR URLS HERE
      // ============================================
      const formA = "https://google.com"; // Replace with your first survey URL
      const formB = "https://bing.com"; // Replace with your second survey URL
      const googleSheetsUrl =
        "https://script.google.com/macros/s/AKfycbzxEQMnnXERy-59MmPeGBz-W8-d1lnuRTB-rfct5-fEbZjPL8H9JB170VNY4KYozGEsCw/exec"; // Your Google Apps Script URL

      // ============================================
      // DO NOT MODIFY BELOW THIS LINE
      // ============================================

      // Form elements
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const nameInput = document.getElementById("participantName");
      const emailInput = document.getElementById("participantEmail");
      const consentButton = document.getElementById("consentButton");
      const participateButton = document.getElementById("participateBtn");
      const errorMessage = document.getElementById("errorMessage");
      const successMessage = document.getElementById("successMessage");
      const digitalSignature = document.getElementById("digitalSignature");
      const studySection = document.getElementById("studySection");

      // Statistics tracking
      let stats = { formA: 0, formB: 0, total: 0 };
      let consentGiven = false;

      // Toggle collapsible sections
      function toggleSection(header) {
        const content = header.nextElementSibling;
        const isActive = content.classList.contains("active");

        // Close all sections
        document.querySelectorAll(".section-content").forEach((section) => {
          section.classList.remove("active");
        });
        document.querySelectorAll(".section-header").forEach((h) => {
          h.classList.remove("active");
        });

        // Open clicked section if it wasn't active
        if (!isActive) {
          content.classList.add("active");
          header.classList.add("active");
        }
      }

      // Check if consent form is complete
      function checkConsentCompletion() {
        const allChecked = Array.from(checkboxes).every(
          (checkbox) => checkbox.checked
        );
        const nameCompleted = nameInput.value.trim().length > 0;
        const emailCompleted =
          emailInput.value.trim().length > 0 && emailInput.validity.valid;

        const formComplete = allChecked && nameCompleted && emailCompleted;
        consentButton.disabled = !formComplete;

        // Update digital signature preview
        if (nameCompleted && emailCompleted) {
          const now = new Date();
          digitalSignature.className = "digital-signature completed";
          digitalSignature.innerHTML = `
                    <div class="signature-name">${nameInput.value.trim()}</div>
                    <div class="signature-email">${emailInput.value.trim()}</div>
                    <div class="signature-date">Digitally signed on ${now.toLocaleDateString()} at ${now.toLocaleTimeString()}</div>
                `;
        } else {
          digitalSignature.className = "digital-signature";
          digitalSignature.innerHTML =
            "Digital signature will appear here when form is completed";
        }

        // Hide error message if form becomes complete
        if (formComplete) {
          errorMessage.style.display = "none";
        }

        // Update progress
        updateProgress();
      }

      // Update progress indicator
      function updateProgress() {
        const step1 = document.getElementById("step1");
        const step2 = document.getElementById("step2");
        const step3 = document.getElementById("step3");
        const line1 = document.getElementById("line1");
        const line2 = document.getElementById("line2");

        // Step 1: Reading information (always completed when page loads)
        step1.classList.add("completed");
        step1.classList.remove("active");

        // Step 2: Consent
        if (consentGiven) {
          step2.classList.add("completed");
          step2.classList.remove("active");
          line1.classList.add("completed");

          // Step 3: Study participation
          step3.classList.add("active");
          step3.classList.remove("completed");
          line2.classList.add("completed");
        } else {
          step2.classList.add("active");
          step2.classList.remove("completed");
          line1.classList.remove("completed");

          step3.classList.remove("active", "completed");
          line2.classList.remove("completed");
        }
      }

      // Record consent
      function recordConsent() {
        // Final validation
        if (consentButton.disabled) {
          errorMessage.style.display = "block";
          errorMessage.scrollIntoView({ behavior: "smooth" });
          return;
        }

        // Prepare consent data
        const consentData = {
          name: nameInput.value.trim(),
          email: emailInput.value.trim(),
          timestamp: new Date().toISOString(),
          ipAddress: "Will be recorded server-side if needed",
          userAgent: navigator.userAgent,
          studyAssignment: "Will be determined by randomizer",
        };

        // Show processing state
        consentButton.disabled = true;
        consentButton.textContent = "⏳ Recording Consent...";

        // Send to Google Sheets using GET method
        const params = new URLSearchParams({
          name: consentData.name,
          email: consentData.email,
          timestamp: consentData.timestamp,
          userAgent: consentData.userAgent,
        });

        fetch(`${googleSheetsUrl}?${params.toString()}`, {
          method: "GET",
        })
          .then((response) => response.text())
          .then((result) => {
            console.log("Consent recorded:", result);
            completeConsent();
          })
          .catch((error) => {
            console.error("Error recording consent:", error);
            completeConsent(); // Still proceed even if recording fails
          });
      }

      // Complete consent process
      function completeConsent() {
        consentGiven = true;
        consentButton.textContent = "✅ Consent Recorded";
        successMessage.style.display = "block";

        // Enable study section
        studySection.classList.add("enabled");
        participateButton.disabled = false;

        // Update progress
        updateProgress();

        // Scroll to study section
        setTimeout(() => {
          studySection.scrollIntoView({ behavior: "smooth" });
        }, 500);
      }

      // Random redirect to study
      function randomRedirect() {
        if (!consentGiven) {
          alert("Please complete the consent process first!");
          return;
        }

        // Check if URLs are still placeholder values
        if (!formA || !formB || formA === "test" || formB === "test") {
          alert(
            "Study URLs not yet configured. Please contact the research team."
          );
          return;
        }

        // Random assignment (50/50 chance)
        const isFormA = Math.random() < 0.5;
        const targetUrl = isFormA ? formA : formB;

        // Update statistics
        if (isFormA) {
          stats.formA++;
        } else {
          stats.formB++;
        }
        stats.total++;

        // Log the assignment
        console.log(`Assigned to: ${isFormA ? "Condition A" : "Condition B"}`);
        console.log(`Redirecting to: ${targetUrl}`);

        // Show final step completion
        document.getElementById("step3").classList.add("completed");
        document.getElementById("step3").classList.remove("active");

        // Redirect immediately
        window.location.href = targetUrl;
      }

      // Add event listeners
      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", checkConsentCompletion);
      });

      nameInput.addEventListener("input", checkConsentCompletion);
      emailInput.addEventListener("input", checkConsentCompletion);

      // Initialize
      checkConsentCompletion();
      updateProgress();
    </script>
  </body>
</html>
